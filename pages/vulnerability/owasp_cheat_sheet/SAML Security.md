はじめに
Security Assertion Markup Language（SAML）は、認可および認証情報の交換のためのオープン標準です。WebブラウザのSAML/SSOプロファイルとリダイレクト/POSTバインディングは、最も一般的なSSO実装の1つです。このチートシートでは、主にそのプロファイルに焦点を当てます。

メッセージの機密性と整合性の検証
メッセージの機密性と整合性を保証するための最も一般的な解決策は、トランスポートレイヤーでのTLS 1.2です。追加情報については、SAMLセキュリティ（セクション4.2.1）を参照してください。このステップは、次の攻撃に対抗します。

盗聴7.1.1.1
ユーザー認証情報の盗難7.1.1.2
ベアラトークンの盗難7.1.1.3
メッセージの削除7.1.1.6
メッセージの改ざん7.1.1.7
中間者攻撃7.1.1.8
認定キーでデジタルに署名されたメッセージは、メッセージの整合性と認証を保証するための最も一般的な解決策です。追加情報については、SAMLセキュリティ（セクション4.3）を参照してください。このステップは、次の攻撃に対抗します。

中間者攻撃6.4.2
偽のアサーション6.4.3
メッセージの改ざん7.1.1.7
属性は、XMLEncを介して暗号化される場合があります。これにより、輸送後の機密属性の開示が防止されます。追加情報については、SAMLセキュリティ（セクション4.2.2）を参照してください。このステップは、次の攻撃に対抗します。

ユーザー認証情報の盗難7.1.1.2
プロトコルの使用を検証する
これはセキュリティの欠陥がよく見られる領域です - 実際の例としてGoogle SSOの脆弱性を参照してください。彼らのSSOプロファイルは、悪意のあるSP（サービスプロバイダー）からの中間者攻撃に対して脆弱でした。

SSO Webブラウザプロファイルは、信頼できるパートナーからの攻撃に最も脆弱です。この特定のセキュリティ上の欠陥は、SAMLレスポンスが安全なメッセージ交換に必要なすべてのデータ要素を含んでいなかったために露出されました。 AuthnRequest（4.1.4.1）およびResponse（4.1.4.2）のSAMLプロファイル使用要件に従うことで、この攻撃に対抗するのに役立ちます。

AVANTSSARチームは、次のデータ要素が必要であると提案しました。

AuthnRequest（ID、SP）：AuthnRequestにはIDとSPが含まれている必要があります。ここで、IDはリクエストを一意に識別する文字列であり、SPはリクエストを開始したサービスプロバイダーを識別します。さらに、リクエストID属性はレスポンスで返される必要があります（InResponseTo="<requestId>"）。 InResponseToは、信頼できるIdPからのレスポンスの正当性を保証するのに役立ちます。これは、GoogleのSSOを脆弱にした欠落した属性の1つでした。
Response（ID、SP、IdP、{AA} K -1/IdP）：レスポンスには、すべてのこれらの要素が含まれている必要があります。ここで、IDはレスポンスを一意に識別する文字列です。SPはレスポンスの受信者を識別し、IdPはレスポンスを承認するアイデンティティプロバイダーを識別します。 {AA} K -1/IdPは、IdPの秘密鍵でデジタルに署名されたアサーションです。
AuthAssert（ID、C、IdP、SP）：認証アサーションは、レスポンス内に存在する必要があります。それにはID、クライアント（C）、アイデンティティプロバイダー（IdP）、およびサービスプロバイダー（SP）識別子が含まれている必要があります。
Signatureの検証
XML署名ラップ攻撃によるSAML実装の脆弱性は、2012年に「SAMLの破壊：望む人になれる」というタイトルで説明されました。

次の推奨事項がこの問題に対応して提案されました（XML署名ラップ攻撃を防ぐための安全なSAML検証）：

セキュリティに関連する目的でXMLドキュメントを使用する前に、常にスキーマ検証を実行します。
検証のために、常にスキーマのローカルで信頼できるコピーを使用します。
第三者の場所からのスキーマの自動ダウンロードを許可しないでください。
可能であれば、スキーマを検査し、ワイルドカードタイプや緩和された処理ステートメントを無効にするスキーマハードニングを実行します。
デジタル署名を安全に検証します：
1つの署名キーのみを期待する場合は、StaticKeySelectorを使用します。キーは、直接アイデンティティプロバイダーから取得し、ドキュメント内のKeyInfo要素を無視してローカルファイルに保存します。
1つ以上の署名キーが予想される場合は、X509KeySelector（JKSバリアント）を使用します。これらのキーを直接アイデンティティプロバイダーから取得し、ローカルのJKSに保存し、ドキュメント内のKeyInfo要素を無視します。
異種の署名付きドキュメント（多くのアイデンティティプロバイダーからの多くの証明書、多レベルの検証パス）が予想される場合は、PKIXおよび信頼できるルート証明書に基づく完全な信頼確立モデルを実装します。
署名ラップ攻撃を回避します。
セキュリティ関連の要素を選択するためにgetElementsByTagNameを使用しないでください。ドキュメントの事前検証なしに、XMLドキュメント内のセキュリティ関連要素を選択しないでください。
検証には、ハードニングスキーマが使用される場合を除き、常に絶対XPath式を使用して要素を選択します。
プロトコル処理ルールの検証
これは、主張する手順の数が非常に多いため、セキュリティの欠陥がよく見られる別の一般的な領域です。

SAMLレスポンスの処理はコストがかかる操作ですが、すべての手順を検証する必要があります：

AuthnRequest処理ルールを検証します。 AuthnRequest処理ルールのすべてについては、SAMLコア（3.4.1.4）を参照してください。このステップは、次の攻撃に対抗します。
中間者攻撃（6.4.2）
Response処理ルールを検証します。すべてのResponse処理ルールについては、SAMLプロファイル（4.1.4.3）を参照してください。このステップは、次の攻撃に対抗します。
盗まれたアサーション（6.4.1）
中間者攻撃（6.4.2）
偽のアサーション（6.4.3）
ブラウザの状態の露出（6.4.4）
バインディングの実装の検証
HTTPリダイレクトバインディングの場合は、SAMLバインディング（3.4）を参照してください。エンコードの例を表示するには、Googleのリファレンス実装内のRequestUtil.javaを参照することができます。
HTTP POSTバインディングの場合は、SAMLバインディング（3.5）を参照してください。キャッシュの考慮事項も非常に重要です。 SAMLプロトコルメッセージがキャッシュされると、それが後で盗まれたアサーション（6.4.1）またはリプレイ（6.4.5）攻撃として使用される可能性があります。
セキュリティ対策の検証
SAMLセキュリティドキュメント内に存在する各セキュリティ脅威を再検討し、特定の実装に存在する可能性のある脅威に対する適切な対策が適用されていることを確認します。

検討される追加の対策には次のものがあります。

適切な場合はIPフィルタリングを優先します。たとえば、Googleが各信頼されたパートナーに別々のエンドポイントを提供し、各エンドポイントにIPフィルタを設定していた場合、Googleの初期のセキュリティ欠陥を防げました。このステップは、次の攻撃に対抗します。
盗まれたアサーション（6.4.1）
中間者攻撃（6.4.2）
SAMLレスポンスの寿命を短くすることを優先します。このステップは、次の攻撃に対抗します。
盗まれたアサーション（6.4.1）
ブラウザの状態の露出（6.4.4）
SAMLレスポンスでOneTimeUseを優先します。このステップは、次の攻撃に対抗します。
ブラウザの状態の露出（6.4.4）
リプレイ（6.4.5）
アーキテクチャ図が必要ですか？ SAML技術概要には最も完全な図が含まれています。リダイレクト/POSTバインディングを使用したWebブラウザSSOプロファイルについては、セクション4.1.3を参照してください。実際、すべてのSAMLドキュメントの中で、技術概要が高レベルの観点から最も価値があります。

要求されていないレスポンス（つまり、IdP起点のSSO）のサービスプロバイダーの考慮事項
要求されていないレスポンスは、CSRF保護の欠如により、設計上セキュリティが低くなっています。ただし、SAML 1.1の後方互換性機能のため、多くのサポートを受けています。一般的なセキュリティの推奨事項は、このタイプの認証をサポートしないようにすることですが、必要な場合は次の手順（上記に加えて）がこのフローをセキュリティで保護するのに役立ちます。

SAMLプロファイル（セクション4.1.5）で言及された検証プロセスに従います。このステップは、次の攻撃に対抗します。
リプレイ（6.1.2）
メッセージの挿入（6.1.3）
RelayStateパラメータの契約がURLの場合は、URLを検証し、明示的に許可リストに含めます。このステップは、次の攻撃に対抗します。
オープンリダイレクト
レスポンスまたはアサーションレベルで適切なリプレイ検出を実装します。これにより、次の攻撃に対抗します。
リプレイ（6.1.2）
アイデンティティプロバイダーおよびサービスプロバイダーの考慮事項
SAMLプロトコルは稀に選択されるベクトルですが、これが堅牢であることを確認するためにチートシートを持っていることが重要です。さまざまなエンドポイントがよりターゲットにされているため、SAMLトークンの生成方法とその使用方法の両方が実践上重要です。

アイデンティティプロバイダー（IdP）の考慮事項
アルゴリズムの互換性、暗号化の強度、輸出制限の強度を検証するためのX.509証明書を検証します
SAMLトークンを生成するための強力な認証オプションを検証します
IDP検証（どのIDPがトークンを発行するか）
可能な場合は、使用/信頼されるルートCAを使用します
共通のインターネットタイムソースに同期します
アイデンティティ検証のための保証レベルを定義します
個人を特定可能な情報（例：SSNなど）よりも、アイデンティティアサーションに対して非対称の識別子を優先します
各個々のアサーションまたは全体のレスポンス要素に署名します
サービスプロバイダー（SP）の考慮事項
ユーザーのセッション状態を検証します
SAMLトークンを消費する際の承認コンテキストの細かい設定レベル（グループ、役割、属性など）のレベル
各個々のアサーションまたは全体のレスポンス要素に署名します
署名を検証します
認定されたIDPによって署名されているかどうかを検証します
IDP証明書の有効期限とCRL/OCSPに対する失効を検証します
NotBeforeおよびNotOnorAfterを検証します
受信者属性を検証します
SAMLログアウトの基準を定義します
セキュアなトランスポート上でのみアサーションを交換します
セッション管理の基準を定義します
可能な場合は、SAMLチケットアサーションから取得したユーザーIDを確認します。
入力検証
SAMLがセキュリティプロトコルであるとしても、入力検証がなくなるわけではありません。

すべてのSAMLプロバイダー/消費者が適切な入力検証を行うことを確認します。
暗号
暗号アルゴリズムに依存するソリューションは、暗号解析の最新の動向に従う必要があります。

チェーン内のすべてのSAML要素が強力な暗号化を使用していることを確認します
安全でないXMLEncアルゴリズムのサポートを廃止することを検討します。