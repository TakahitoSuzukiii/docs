OAuth 2.0プロトコルチートシート

概要：
このチートシートは、OAuth 2.0のRFC [2][3]から派生した、現在の最良のセキュリティプラクティス[1]を説明しています。OAuthはAPI保護の標準となり、OpenID Connectを使用したフェデレーテッドログインの基盤となりました。OpenID Connect 1.0は、OAuth 2.0プロトコルの上にあるシンプルなアイデンティティレイヤーです。これにより、クライアントは認証サーバーによって行われた認証に基づいてエンドユーザーのアイデンティティを検証し、エンドユーザーに関する基本的なプロファイル情報を相互運用可能でREST風の方法で取得することができます。

用語：
アクセストークン = リソースサーバーが理解する単一のトークンに、さまざまな認可構造（ユーザー名とパスワード、アサーションなど）を置き換える抽象化を提供します。この抽象化により、短期間有効なアクセストークンを発行したり、リソースサーバーが幅広い認証方式を理解する必要がなくなります。
リフレッシュトークン = アクセストークンを取得するために使用される資格情報です。これらはクライアントによって認可サーバーから発行され、現在のアクセストークンが無効になったり期限切れになったりした場合、またはリソースオーナーによって認可されたより短い寿命と少ない権限を持つ追加のアクセストークンを取得するために使用されます。
クライアント = リソースオーナーの承認を得て、リソースオーナーを代表して保護されたリソースリクエストを行うアプリケーションを一般的に指します。この用語の「クライアント」は、特定の実装特性（サーバー上で実行されるアプリケーション、デスクトップ、その他のデバイスなど）を意味しません。
認可サーバー（AS） = リソースオーナーを正常に認証し、承認を得た後にクライアントにアクセストークンを発行するサーバーを指します。
リソースオーナー（RO） = 保護されたリソースへのアクセスを許可できるエンティティを指します。リソースオーナーが人物の場合、エンドユーザーと呼ばれます。
リソースサーバー（RS） = 保護されたリソースをホストするサーバーで、アクセストークンを使用して保護されたリソースリクエストに応答することができます。
OAuth 2.0の基本事項：
クライアントと認可サーバーは、ユーザーのブラウザを任意のURIに転送するURLを公開してはなりません（「オープンリダイレクター」）。これにより、認可コードやアクセストークンの漏洩が可能になります。
PKCEをサポートしていることを確認したクライアントは、PKCEによって提供されるCSRF保護に依存する場合があります。OpenID Connectフローでは、「nonce」パラメーターがCSRF保護を提供します。それ以外の場合、ワンタイムユーザーCSRFトークンが「state」パラメーターに含まれ、ユーザーエージェントに安全にバインドされている必要があります。
OAuthクライアントが複数の認可サーバーとやり取りする場合、クライアントは対策として発行者「iss」パラメーターを使用するか、オープンIDのIDトークン内の「iss」値に基づいてください。
他の対策オプションがない場合、OAuthクライアントが複数の認可サーバーとやり取りする場合、クライアントは代わりに異なるリダイレクトURIを使用して認可エンドポイントとトークンエンドポイントを識別する必要があります。
認可サーバーは、ユーザー資格情報が含まれている可能性のあるリクエストを誤って転送またはリダイレクトしないようにする必要があります。
PKCE（Proof Key for Code Exchange） - 証明コード交換メカニズム：
OAuth 2.0のパブリッククライアントは、認可コードグラントを利用する際に認可コードの傍受攻撃の脆弱性があります。PKCE（Proof Key for Code Exchange、"pixy"と発音）は、認可コードの傍受攻撃の

脅威を軽減するために使用される技術です。

元々、PKCEはネイティブアプリをセキュアにすることを目的としていましたが、後にOAuthの機能として展開されました。これは認可コードのインジェクション攻撃だけでなく、公開クライアント向けに作成された認可コードも保護します。PKCEは、攻撃者がcode_verifierの知識なしに認可サーバーのトークンエンドポイントで盗まれた認可コードを利用できないようにします。

クライアントは、PKCEフローを使用することで、認可コードのインジェクション（再生）を防止しています。また、クライアントはOpenID Connectの「nonce」パラメーターとID Token内の対応するクレームを使用する場合があります。PKCEのチャレンジまたはOpenID Connectの「nonce」は、トランザクション固有であり、トランザクションが開始されたクライアントとユーザーエージェントに安全にバインドされている必要があります。
PKCEを使用する場合、クライアントは認可リクエストでPKCE検証子を公開しないPKCEコードチャレンジ方法を使用する必要があります。そうでない場合、認可リクエストを読み取れる攻撃者は、PKCEによって提供されるセキュリティを破ることができます。認可サーバーはPKCEをサポートする必要があります。
クライアントが認可リクエストで有効なPKCE「code_challenge」パラメーターを送信する場合、認可サーバーはトークンエンドポイントで「code_verifier」の正しい使用を強制します。
認可サーバーは、認可リクエストに「code_challenge」パラメーターが存在する場合にのみ、トークンリクエストを受け入れるようにし、PKCEダウングレード攻撃を緩和しています。
暗黙的なグラント：
暗黙的なグラントは、JavaScriptなどのスクリプティング言語を使用してブラウザに実装されたクライアント向けに最適化された簡略化された認可コードフローです。暗黙的なフローでは、クライアントに認可コードが発行されるのではなく、クライアントに直接アクセストークンが発行されます（リソースオーナーの認可の結果として）。認可タイプは暗黙的であり、中間資格情報（認可コードなど）は発行されません（後でアクセストークンを取得するために使用されます）。

クライアントは、「code」（認可コードグラントタイプの別名）または他の任意の応答タイプを使用してアクセストークンをトークン応答で発行するようにしています。これにより、認可サーバーは攻撃者による再生試行を検出でき、一般的にアクセストークンがURLに公開されないため、攻撃面が削減されます。また、これにより、認可サーバーは発行されたトークンを送信元制約できます。
トークンのリプレイ防止：
認可サーバーとリソースサーバーは、アクセストークンを送信元に制約するメカニズムを使用してトークンのリプレイを防止しています。これには、OAuth 2.0の相互TLSまたはOAuth Possessionのデモンストレーション（DPoP）が含まれます。
リフレッシュトークンは、送信元に制約されているか、リフレッシュトークンのローテーションが使用されています。
アクセストークンの権限制限：
アクセストークンに関連付けられた権限は、特定のアプリケーションまたはユースケースで必要な最小限に制限する必要があります。これにより、クライアントがリソースオーナーが承認した権限を超えることが防止されます。また、ユーザーが対応するセキュリティポリシーで承認された権限を超えることも防止されます。権限制限はアクセストークンの漏洩の影響を軽減するのにも役立ちます。
アクセストークンは特定のリソースサーバー（オーディエンス制限）に制限されています。できれば、1つのリソースサーバーに制限されている方が良いです。認可サーバーは、アクセストークンを特定のリソースサーバーと関連付け、すべてのリクエストに対して、そのリクエストで送信されたアクセストークンがその特定のリソースサーバーで使用するために意図されて

いるかどうかを検証する必要があります。そうでない場合、リソースサーバーは対応するリクエストを拒否する必要があります。クライアントと認可サーバーは、それぞれ「scope」と「resource」パラメーターを使用して、アクセスしたいリソースサーバーを特定できます。
アクセストークンは、リソースサーバーまたはリソース上の特定のリソースおよびアクションに制限されています。認可サーバーはアクセストークンを対応するリソースとアクションに関連付け、すべてのリクエストに対して、そのリクエストで送信されたアクセストークンが特定のアクションに対する特定のリソースで使用されるように意図されているかどうかを検証する必要があります。そうでない場合、リソースサーバーは対応するリクエストを拒否する必要があります。クライアントと認可サーバーは、それぞれ「scope」と「authorization_details」パラメーターを使用して、これらのリソースおよび/またはアクションを特定できます。
リソースオーナーパスワード資格情報グラント：
リソースオーナーパスワード資格情報グラントは使用されていません。このグラントタイプは、リソースオーナーの資格情報をクライアントに安全に公開し、アプリケーションの攻撃面を増加させます。
クライアント認証：
可能な場合、認可サーバーはクライアント認証を使用しています。mTLSや「private_key_jwt」（OpenID Connectなど）などの非対称（公開鍵ベース）の方法を使用してクライアント認証を行うことが推奨されています。非対称メソッドを使用する場合、認可サーバーは機密性の高い対称キーを格納する必要がないため、これらのメソッドはいくつかの攻撃に対してより堅牢です。
その他の推奨事項：
認可サーバーは、クライアントが「client_id」または「sub」値、または真のリソースオーナーと混同される可能性のある他のクレームを影響することを許可していません。エンドツーエンドのTLSを使用することをお勧めします。
認可レスポンスは暗号化されていないネットワーク接続経由で送信されません。認可サーバーは、「http」スキームを使用するリダイレクトURIを許可しません（ループバックインターフェースリダイレクションを使用するネイティブクライアントを除く）。