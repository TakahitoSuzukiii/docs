概要¶
適切なユーザー管理システムを実装するために、システムはユーザーがパスワードのリセットを要求できる「パスワードを忘れた」サービスを統合します。

この機能は直感的で実装が容易に見えるものの、ユーザー列挙攻撃などの著名な脆弱性の一般的な原因となります。

以下の簡単なガイドラインは、パスワードを忘れたサービスを保護するためのクイックリファレンスとして使用できます：

既存のアカウントと存在しないアカウントの両方に対して一貫したメッセージを返す。
ユーザー応答メッセージの所要時間が一定であることを確認する。
パスワードをリセットする方法を通信するためのサイドチャネルを使用する。
最も簡単かつ迅速な実装のためにURLトークンを使用する。
生成されたトークンやコードが次のようであることを確認する：
暗号的に安全なアルゴリズムを使用してランダムに生成されます。
ブルートフォース攻撃に対して十分に長いです。
安全に保存されます。
適切な期間後に単一の使用で期限切れになります。
有効なトークンが提示されるまで、アカウントに変更を加えない（アカウントのロックアウトなど）。
このチートシートは、ユーザーのパスワードをリセットすることに焦点を当てています。マルチファクタ認証（MFA）のリセットに関するガイダンスについては、マルチファクタ認証チートシートの該当セクションを参照してください。

パスワードを忘れたサービス¶
パスワードのリセットプロセスは、以下のセクションで詳しく説明されている2つの主要なステップに分割できます。

パスワードを忘れたリクエスト¶
ユーザーがパスワードを忘れたサービスを使用し、ユーザー名または電子メールを入力すると、以下のセキュアなプロセスを実装するために以下の手順に従う必要があります：

既存のアカウントと存在しないアカウントの両方に対して一貫したメッセージを返す。
アタッカーがどのアカウントが存在するかを列挙するのを防ぐために、応答が一定時間になるようにします。これは、非同期呼び出しを使用するか、クイックエグジット方法の代わりに同じロジックが従われるようにすることで実現できます。
アカウントごとの自動送信の過剰な提出に対する保護を実装します。これには、CAPTCHAの必要性やその他の制御の必要性が含まれます。さもないと、アタッカーは特定のアカウントに対して1時間に何千ものパスワードリセットリクエストを行い、ユーザーの受信システム（例えば、電子メールの受信箱やSMS）を無駄なリクエストで氾濫させる可能性があります。
SQLインジェクション防止方法や入力検証などの通常のセキュリティ対策を実装します。
ユーザーがパスワードをリセットする¶
ユーザーが（メールで送信されたトークンを介して）自分の身元を証明した場合、新しいセキュアなパスワードにリセットするために以下の対策を取る必要があります。

ユーザーは、2回書いてパスワードを確認する必要があります。
安全なパスワードポリシーが設定されていることを確認し、アプリケーションの残りの部分と一貫していることを確認します。
安全な慣行に従ってパスワードを更新および保存します。
ユーザーに、パスワードがリセットされたことを通知するメールを送信します（メールにパスワードを送信しないでください！）。
新しいパスワードを設定した後、ユーザーは通常のメカニズムを介してログインする必要があります。ユーザーを自動的にログインさせないでください。これにより、認証およびセッション処理コードに追加の複雑さが導入され、脆弱性が導入される可能性が高まります。
ユーザーがすべての既存のセッションを無効にするか、セッションを自動的に無効にするかユーザーに尋ねます。
方法¶
パスワードをリセットするためにユーザーにリクエストを許可するには、ユーザーを識別する方法か、サイドチャネルを介してユーザーにアプローチする手段が必要です。

これは以下の方法で行うことができます：

URLトークン。
PIN
オフラインメソッド
セキュリティ質問。
これらの方法は併用して、ユーザーが主張するとおりであることをより高い確度で保証することができます。どの場合でも、ユーザーが常にアカウントを回復できる方法を確保する必要があります。これには、サポートチームに連絡し、スタッフに自分の身元を証明することが含まれます。

一般的なセキュリティ慣行¶
リセット識別子（トークン、コード、PINなど）に良好なセキュリティ慣行を採用することが不可欠です。いくつかのポイントはオフライン方法には適用されないため、寿命制限は適用されません。すべてのトークンとコードは次のようである必要があります：

暗号化された安全な乱数ジェネレーターによって生成されます。
ブルートフォース攻撃に対して十分に長いです。
データベース内の個々のユーザーにリンクされています。
使用された後に無効にされます。
パスワードストレージチートシートで議論されているように、安全な方法で保存されます。
URLトークン¶
URLトークンはURLのクエリ文字列で渡され、通常はユーザーに電子メールで送信されます。プロセスの基本的な概要は次のとおりです：

ユーザーにトークンを生成し、URLのクエリ文字列に添付します。
このトークンをユーザーに電子メールで送信します。
ホストヘッダーに頼らずにリセットURLを作成する場合は、ホストヘッダーインジェクション攻撃を回避するために、URLをハードコードするか、信頼できるドメインのリストに対して検証する必要があります。
URLがHTTPSを使用していることを確認してください。
ユーザーが電子メールを受信し、トークンが添付されたURLに移動します。
リセットパスワードページが、リファラポリシータグをnoreferrer値で追加することにより、リファラ漏洩を回避するようにします。
レート制限などの適切な保護を実装して、URL内のトークンのブルートフォース攻撃を防止します。
必要に応じて、ユーザーにセキュリティ質問に答えることを要求するなど、追加の検証手順を実行します。
ユーザーに新しいパスワードを作成し、確認させます。アプリケーションの他の場所で使用されている同じパスワードポリシーが適用されていることを確認します。
注：URLトークンはPINと同じ振る舞いをすることができます。トークンから制限されたセッションを作成します。開発者のニーズと専門知識に基づいて決定する必要があります。

PIN¶
PINは、SMSなどのサイドチャネルを介してユーザーに送信される6桁から12桁の数字です。

PINを生成します。
ユーザーにそれをSMSまたは別のメカニズムで送信します。
スペースでPINを分割すると、ユーザーが読み取りやすく入力しやすくなります。
ユーザーは、ユーザー名とともにPINをパスワードリセットページに入力します。
そのPINから制限されたセッションを作成し、ユーザーがパスワードをリセットできるようにします。
ユーザーに新しいパスワードを作成し、確認させます。アプリケーションの他の場所で使用されている同じパスワードポリシーが適用されていることを確認します。
オフラインメソッド¶
オフラインメソッドは、ユーザーがバックエンドから特別な識別子（トークンやPINなど）を要求せずにパスワードをリセットできるようにすることで、他の方法と異なります。ただし、要求が正当であることを確認するために、認証はバックエンドによって実施される必要があります。オフラインメソッドは、登録時に特定の識別子を提供したり、ユーザーがそれを設定する場合に提供される必要があります。

これらの識別子は、オフラインで安全に保存され、バックエンドは一般的なセキュリティ慣行に適切に従う必要があります。一部の実装は、ハードウェアOTPトークン、証明書、またはエンタープライズ内で使用できる他の実装に基づいて構築されています。これらはこのチートシートの対象外です。

バックアップコード¶
バックアップコードは、ユーザーが登録時に提供され、ユーザーがオフラインで安全な場所に保存する必要があります（たとえば、パスワードマネージャー）。この方法を実装する際は、次の慣行に従う必要があります：

改善されたセキュリティのための最小8桁の長さ、12桁。
1つのコードが機能することを確認するために、ユーザーがいつでも複数の回復コードを持っている必要があります（ほとんどのサービスはユーザーに10個のバックアップコードを提供します）。
サードパーティによって侵害された場合、すべての既存の回復コードを無効にするプロセスを実装する必要があります。
アタッカーがバックアップコードのブルートフォース攻撃を防ぐために、レート制限やその他の保護措置を実装する必要があります。
セキュリティ質問¶
セキュリティ質問は、回答が頻繁にアタッカーによって容易に推測可能または入手可能であるため、パスワードをリセットするための唯一のメカニズムとして使用すべきではありません。ただし、このチートシートで議論されている他の方法と組み合わせると、追加のセキュリティレイヤーを提供できます。使用する場合は、セキュアな質問が選択されていることを確認してください。

アカウントロックアウト¶
パスワードを忘れた攻撃に応答してアカウントをロックアウトするべきではありません。これにより、既知のユーザー名を持つユーザーのアクセスを拒否することができます。アカウントロックアウトの詳細については、認証チートシートを参照してください。