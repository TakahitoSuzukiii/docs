CI/CD セキュリティチートシート

概要
CI/CD パイプラインとプロセスは、効率的で繰り返し可能なソフトウェアのビルドおよびデプロイメントを促進し、現代の SDLC において重要な役割を果たしています。しかし、その重要性と人気から、CI/CD パイプラインは悪意のあるハッカーにとって魅力的な標的でもあり、そのセキュリティは無視できません。このチートシートの目的は、これらの重要なコンポーネントに関連するリスクを軽減するための開発者向けの実践的なガイドラインを提供することです。このチートシートでは、パイプライン自体のセキュリティに焦点を当てます。具体的な CI/CD セキュリティのベストプラクティスに進む前に、いくつかの簡単な背景情報を提供します。

定義と背景
CI/CD とは、主に自動化されたプロセスのセットで、ソフトウェアをビルドして提供するために使用されます。これは、一連の順序付けされた、個別のステップから成るパイプラインとして表現されることがよくあります。パイプラインは通常、開発中のコードがリポジトリにプッシュされ、すべてのステップが成功裏に完了した場合に、ソフトウェアソリューションがビルドされ、テストされ、本番環境にデプロイされることで終了します。CI/CD は、連続インテグレーション（CI）と連続デリバリーおよび/または連続デプロイメント（CD）の 2 つの異なる部分に分解されることがあります。CI はビルドとテストの自動化に焦点を当てています。連続デリバリーは、このビルドされたコードをステージングまたはそれ以上の環境にプロモーションし、通常は追加の自動化されたテストを実行することに焦点を当てています。連続デリバリーと連続デプロイメントは、常に CI/CD の定義において区別されるとは限りませんが、NIST によれば、連続デリバリーはコードを手動で本番環境にプッシュする必要があり、連続デプロイメントはさらにこの手順を自動化します。

CI/CD パイプラインの具体的なステップは組織ごと、プロジェクトごとに異なる場合がありますが、自動化およびそれがもたらす繰り返し性と適応性が、どの CI/CD 実装でも中心的な焦点であるべきです。

CI/CD のリスクの理解
CI/CD には多くの利点がありますが、同時に組織の攻撃面を増加させます。CI/CD には人、プロセス、技術が必要であり、これらすべてが攻撃の手段になります。コードリポジトリ、Jenkins のような自動化サーバー、デプロイ手順、CI/CD パイプラインを実行するノードなど、悪意のあるエンティティによって悪用される可能性のある CI/CD コンポーネントのいくつかの例があります。さらに、CI/CD ステップは高特権のアイデンティティを使用して頻繁に実行されるため、CI/CD に対する成功した攻撃は高い被害の可能性があります。組織が CI/CD の多くの利点を活用することを選択する場合、適切にセキュリティを確保するために必要なリソースを投資することも重要です。Codecov と SolarWinds の侵害は、CI/CD の妥協の可能性の潜在的な影響の 2 つの気を引く例です。

攻撃者が CI/CD 環境を悪用する具体的な方法はさまざまですが、特定のリスクは他よりも顕著です。それらの知識にとらわれるべきではありませんが、CI/CD 環境への最も顕著なリスクを理解することで、組織がセキュリティリソースをより効率的に割り当てるのに役立ちます。OWASP のトップ 10 CI/CD セキュリティリスクはこの目的のための貴重なリソースです。このプロジェクトでは、以下のものをトップ 10 の CI/CD リスクとして特定しています。

CICD-SEC-1: 不十分なフロー制御メカニズム
CICD-SEC-2: 不適切なアイデンティティおよびアクセス管理
C

ICD-SEC-3: 依存関係チェーンの悪用
CICD-SEC-4: 毒入りパイプラインの実行（PPE）
CICD-SEC-5: 不十分な PBAC（パイプラインベースのアクセスコントロール）
CICD-SEC-6: 不十分な資格情報のハイジニック
CICD-SEC-7: セキュアなシステム構成の不備
CICD-SEC-8: サードパーティサービスの無統制な使用
CICD-SEC-9: 不適切なアーティファクトの整合性検証
CICD-SEC-10: 不十分なログ記録と可視性
このチートシートの残りの部分では、これらのトップ 10 およびその他の CI/CD リスクに対処するためのガイダンスを提供することに焦点を当てます。

セキュアな構成
CI/CD プロセスを可能にするような要素（SCM システムや Jenkins、TeamCity などの自動化サーバー）を適切にセキュリティ設定するためには、時間と労力を投資する必要があります。特定のツールが使用されているかどうかに関係なく、ベンダーのデフォルト設定にだけ依存してはいけません。同時に、設定変更を行う際にはその影響を完全に理解することなく設定を調整してはいけません。変更管理と適切なガバナンスが必要です。さらに、教育も重要です。コードデプロイメントなどの重要なセキュリティ感度の高い操作を実行するためにツールを利用する前に、その基盤技術を理解するための時間を確保することが重要です。セキュアな構成は自動的に行われるものではありません。教育と計画が必要です。

さらに、上記で特定された SCM システム、コンテナイメージ、Web サーバー、または他のインフラストラクチャのセキュリティも確保する必要があります。これらのシステムは適切にパッチを当てる必要があり、ソフトウェアバージョンを含むこれらの資産のインベントリも維持する必要があります。これらのテクノロジは、適切な場合には CIS ベンチマークや STIG などの基準に従ってハードニングする必要があります。

これらの一般的な原則の他に、CI/CD 構成に関連するいくつかの具体的なガイドラインを以下で探ります。

セキュア SCM 構成
CI/CD 環境では、コードをリポジトリにプッシュし、ほとんど手動で本番環境にデプロイすることができます。ただし、これによって未信頼で悪意のあるコードを直接本番システムにデプロイできる攻撃ベクトルにすぐに変わる可能性があります。SCM システムの適切な設定は、このリスクを軽減するのに役立ちます。ベストプラクティスは次のとおりです。

Gitlab、Github、またはBitbucketなどのプラットフォームでの自動マージルールの使用を避ける。
マージする前にプルリクエストのレビューが必要であり、このレビューステップをバイパスできないようにする。
保護されたブランチを利用する。
コミットに署名が必要
一時的な貢献者を許可するリスクとメリットを慎重に検討する。可能な限り外部の貢献の数と権限を制限する。
可能な場合は MFA を有効にする
パイプラインと実行環境
SCM システムに加えて、パイプラインの実行を担当する自動化サーバーも安全に構成することが重要です。これらのテクノロジの例には、Travis、TeamCity、Jenkins、CircleCI などがあります。特定のプラットフォームによってハードニングプロセスは異なりますが、一般的なベストプラクティスには次のようなものがあります。

適切に分離されたノードでビルドを実行する（Jenkinsの例はこちら）
SCM と CI/CD プラットフォーム間の通信が、TLS 1.2 以上などの広く受け入れられているプロトコルを使用してセキュリティで保護されていることを確認する。
可能であれば、CI 設定ファイルをコードがホストされているリポジトリの外部に保存する。ファイルがコードと一緒に保存されている場合は、マージリクエストが承認される前に

ファイルをレビューする必要があります。
適切なレベルのログを有効にする（以下の可視性とモニタリングで詳しく説明）
言語に適した SAST、DAST、IaC 脆弱性スキャンや関連ツールをパイプラインに組み込む。
本番展開をトリガーする前に、手動で承認とレビューを要求する。
パイプラインステップが Docker イメージで実行される場合は、--privileged フラグを使用しない
パイプラインの構成コードがバージョン管理されていることを強制する
可能な場合は MFA を強制する
IAM
Identity and Access Management（IAM）は、デジタルアイデンティティを管理し、それらがデジタルリソースへのアクセスを制御するプロセスです。アイデンティティの例には、システムアカウント、ロール、グループ、または個々のユーザーアカウントがあります。IAM は CI/CD 以外の広範な用途がありますが、アイデンティティとそれらの基盤となる資格情報の適切な管理が CI/CD 環境に影響するリスクの中でも最も重要です。次のサブセクションでは、CI/CD 環境に特に関連する IAM 関連のセキュリティベストプラクティスを強調します。

Secrets Management
シーCRET、つまり API キーやパスワードなどのシーCRETは、CI/CD パイプラインが正常に実行されるためにはしばしば必要です。CI/CD 環境でのシーCRETは多岐にわたり、少なくともいくつかは感...
最小特権
最小特権とは、NIST によって次のように定義されます。

セキュリティアーキテクチャが、各エンティティがその機能を実行するために必要な最小限のシステムリソースと許可を与えられるように設計されている原則。

CI/CD 環境のコンテキストでは、この原則は少なくとも 3 つの主要なエリアに適用されるべきです。パイプラインステップ内で外部リソースにアクセスするために使用されるシーCRET、CI/CD プラットフォームで構成された他のリソースへのパイプラインまたはステップのアクセス、およびパイプラインを実行する OS ユーザーのアクセス権です。

特定のアプリケーションに関係なく、一般的なガイダンスは同じです。アクセスは正当化され、想定されていないことはありません。デフォルトで拒否するマインドセットを採用する必要があります。パイプライン内で使用されるアイデンティティは、その仕事を完了するのに必要な最小限の権限のみが割り当てられるべきです。たとえば、パイプラインが AWS サービスにアクセスする必要がある場合、そのパイプラインで使用される AWS の資格情報は、そのタスクを完了するために必要な特定のサービスとリソース上で特定の操作のみを実行できるようにする必要があります。同様に、パイプライン間での資格情報の共有は最小限に抑える必要があります。特に、異なる感度や価値のレベルを持つパイプライン間での共有は行われてはいけません。パイプライン A がパイプライン B が必要とするシーCRETにアクセスする必要がない場合、理想的にはそれらを共有しません。最後に、パイプラインを実行する OS アカウントは root または同等の特権を持っていてはいけません。これにより、侵害の影響を軽減できます。

アイデンティティライフサイクル管理
適切なシーCRET管理と最小特権の原則の適用は、セキュアな IAM に必要ですが、これだけでは十分ではありません。アイデンティティのライフサイクル、作成から廃棄までの管理は、CI/CD およびその他の環境のリスクを軽減するために慎重に管理する必要があります。

アイデンティティ管理の初期または「参加者」フェーズ（ILM プレイブックで定義されているように）、中央の IdP を使用してローカルアカウントを許可せず、共有アカウントを許可せず、アイデンティティの自己プロビジョニングを許可せず、CI/CD 環境を管理する組織によって制御されているドメインの

外部からのアクセスを許可しないことが重要です。また、アイデンティティの委任された管理者が、正当な業務要件を満たしていない限り、新しいアカウントを作成するためのプロセスを暗号化し、識別子、グループ、およびロールの定義と権限の割り当てを効果的に管理するプロセスを確立する必要があります。アイデンティティの使用中フェーズでは、定期的なアクセスレビューと不要な権限の削除が重要です。最後に、アイデンティティの廃棄フェーズでは、退職した従業員またはプロジェクトに関連するアカウントを即座に無効にすることが不可欠です。

IAM セキュリティの監視
IAM プラクティスを実装するだけでなく、それらが適切に機能していることを確認することも重要です。IAM セキュリティの監視は、認証されたユーザーやサービスアカウントが想定されたタスクのみを実行していることを確認するために、定期的な監査と監視を実施するプロセスです。このタイプの監視は、パイプライン実行ログ、アクセス権の変更履歴、不正なアクセス試行の検出などを含むべきです。次のようなセキュリティ監視の実装が役立ちます。

IAM アクションログの監視とアラート。特に、想定されていないアクセスがある場合や、アイデンティティに不審なアクセス権が付与された場合にアラートをトリガーするように設定します。
アクセス権の変更のレビューと承認プロセスの実装
適切なアクセス権モデルとリソースタグを使用して、アクセス権を管理します。
定期的なアクセス権のレビューと精査。このプロセスは定期的に行われるべきです。新しいアクセス権の付与と古いアクセス権の削除は、変更管理として構成する必要があります。
セキュリティ監視の結果を定期的にレビューし、変更を実装する
可視性とモニタリング
CI/CD セキュリティの別の重要な側面は、プロセス全体の可視性とモニタリングです。正常な操作、悪意のある行動、または緊急のインシデントの特定、調査、および対応には、適切な可視性とモニタリングが必要です。これには、以下が含まれます。

パイプライン実行のログの収集と保持。これには、ビルドログ、テストログ、およびデプロイメントログが含まれます。
アクセス権変更のログの収集と保持。誰がどのようなアクセス権を変更し、変更された内容は何かを記録する必要があります。
パイプラインの悪用を特定するための異常検出とアラート。たとえば、パイプラインが通常よりも高い特権で実行されている場合、または異なる場所からの同時実行が検出された場合、アラートがトリガーされるべきです。
アイデンティティとアクセス権の監視に加えて、パイプラインの各ステップの詳細なログを収集することが重要です。これにより、正常な操作と潜在的なセキュリティ問題の両方を特定しやすくなります。ログデータは長期間にわたって保持することが重要であり、調査が必要な場合に利用できるようになるべきです。

結論
CI/CD セキュリティは、現代のソフトウェア開発プロセスにおいて不可欠です。適切に実装および管理されていれば、CI/CD パイプラインは効率性と信頼性を向上させ、アジャイルな開発プロセスを可能にします。しかし、セキュリティが不適切に管理されている場合、CI/CD 環境は悪意のある攻撃の標的になります。CI/CD セキュリティの実装には、適切な設定、最小特権の原則、IAM のセキュリティ管理、および監視と可視性の確保が含まれます。これらの実践を適用することで、組織はソフトウェアプロセスの効率性とセキュ

リティを両立させることができます。